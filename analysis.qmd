---
title: "Grader Prompt Score Analysis"
format: html
jupyter: python3
---

This document visualizes how each grader prompt's scores vary across different layer indexes, model scales, and strengths.

```{python}
# | echo: false
# | warning: false
from introspection.analysis import load_and_process_data, aggregate_scores

import pandas as pd
import inspect_viz as viz
from inspect_viz import input, layout
from inspect_viz.mark import dot, line
from inspect_viz.plot import plot, legend

df = load_and_process_data("logs/")
df_agg = aggregate_scores(df)
```

## Data Summary

```{python}
# | echo: false
print(f"Total samples: {len(df):,}")
print(f"Unique concepts: {df['concept'].nunique()}")
print()

# Summary by model scale
print("=== By Model Scale ===")
model_summary = df.groupby("model_scale").agg(
    samples=("score", "count"),
    layers=("layer_index", lambda x: sorted(x.unique().tolist())),
).reset_index()
for _, row in model_summary.iterrows():
    print(f"  {row['model_scale']}: {row['samples']:,} samples, layers {row['layers']}")
print()

# Summary by strength
print("=== By Strength ===")
for strength, count in df["strength"].value_counts().sort_index().items():
    print(f"  {strength}: {count:,} samples")
print()

# Summary by temperature
print("=== By Temperature ===")
for temp, count in df["temperature"].value_counts().sort_index().items():
    print(f"  {temp}: {count:,} samples")
print()

# Concepts list
print("=== Concepts ===")
concepts = sorted(df["concept"].unique())
print(f"  {concepts}")
```

## Interactive Visualization

Use the filters below to explore the data. Checkboxes allow you to toggle multiple grader prompts and conditions (control vs intervention) independently.

```{python}
# | echo: false
# Helper to format labels: replace underscores with spaces and title case
def format_label(s: str) -> str:
    return s.replace("_", " ").title()


# Convert numeric columns to strings for dropdown compatibility
df_agg["strength"] = df_agg["strength"].astype(str)

# Create formatted versions for display
df_agg["grader_prompt_display"] = df_agg["grader_prompt"].apply(format_label)
df_agg["condition_display"] = df_agg["condition"].apply(format_label)
df_agg["series"] = (
    df_agg["grader_prompt_display"] + " (" + df_agg["condition_display"] + ")"
)

# Create single Data instance for synchronized filtering
data = viz.Data(df_agg)
selection = viz.Selection.intersect()

# Dropdown filters for model scale and strength (value="auto" selects first, no "All" option)
model_scale_filter = input.select(
    data=data,
    column="model_scale",
    target=selection,
    label="Model Scale",
    value="auto",
)

strength_filter = input.select(
    data=data,
    column="strength",
    target=selection,
    label="Strength",
    value="auto",
)

# Checkbox toggles for grader prompts and conditions (using formatted display columns)
grader_prompt_filter = input.checkbox_group(
    data=data,
    column="grader_prompt_display",
    target=selection,
    label="Grader Prompt",
)

condition_filter = input.checkbox_group(
    data=data,
    column="condition_display",
    target=selection,
    label="Condition",
)

# Create the plot
the_plot = plot(
    line(
        data=data,
        x="layer_percentage",
        y="mean_score",
        stroke="series",
        filter_by=selection,
    ),
    dot(
        data=data,
        x="layer_percentage",
        y="mean_score",
        fill="series",
        filter_by=selection,
        r=5,
        channels={
            "Grader Prompt": "grader_prompt_display",
            "Condition": "condition_display",
            "Layer %": "layer_percentage",
            "Mean Score": "mean_score",
            "Model Scale": "model_scale",
            "Strength": "strength",
        },
    ),
    x_label="Layer Percentage",
    y_label="Mean Score",
    width=2000,
    height=1200,
    margin_left=60,
    margin_top=40,
    margin_right=40,
    margin_bottom=120,
    legend=legend("color", frame_anchor="bottom", columns=2, border=False),
    grid=True,
    y_domain=[0, 1.0],
    x_domain=[0, 100],
    color_domain="fixed",
    style={"fontSize": "20px"},
)

# Combine filters and plot into single layout for display
# Put grader prompt and condition on separate rows to avoid overlap
layout.vconcat(
    layout.hconcat(model_scale_filter, strength_filter),
    grader_prompt_filter,
    condition_filter,
    the_plot,
)
```
